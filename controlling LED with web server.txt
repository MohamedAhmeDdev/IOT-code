#include <WiFi.h>
#include <WebServer.h>

// WiFi credentials
const char* ssid = "The palace_ext";
const char* password = "elmiroyalty";

// LED control
const int ledPin = 4;

WebServer server(80);

void setup() {
  Serial.begin(115200);
  pinMode(ledPin, OUTPUT);
  digitalWrite(ledPin, LOW);

  // Connect to WiFi with better debugging
  Serial.println();
  Serial.println("Attempting to connect to WiFi...");
  Serial.print("SSID: ");
  Serial.println(ssid);
  
  WiFi.begin(ssid, password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(1000);
    Serial.print(".");
    attempts++;
    
    if (attempts % 10 == 0) {
      Serial.println();
      Serial.print("Still trying... Status: ");
      Serial.println(WiFi.status());
    }
  }
  
  Serial.println();
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("WiFi connected successfully!");
    Serial.print("IP address: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("Failed to connect to WiFi!");
    Serial.print("Status code: ");
    Serial.println(WiFi.status());
    return;
  }

  // Setup server routes
  server.on("/", handleRoot);
  server.on("/on", handleOn);
  server.on("/off", handleOff);
  
  server.begin();
  Serial.println("HTTP server started");
}

void loop() {
  server.handleClient();
}

void handleRoot() {
  String html = R"rawliteral(
  <!DOCTYPE html>
  <html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body {font-family: Arial; text-align: center; margin-top: 50px;}
      .button {
        padding: 15px 25px;
        font-size: 24px;
        cursor: pointer;
        margin: 10px;
        border-radius: 12px;
        border: none;
      }
      .on {background-color: #4CAF50; color: white;}
      .off {background-color: #f44336; color: white;}
    </style>
  </head>
  <body>
    <h1>ESP32 LED Control</h1>
    <button class="button on" onclick="location.href='/on'">LED ON</button>
    <button class="button off" onclick="location.href='/off'">LED OFF</button>
  </body>
  </html>
  )rawliteral";
  
  server.send(200, "text/html", html);
}

void handleOn() {
  digitalWrite(ledPin, HIGH);
  server.sendHeader("Location", "/");
  server.send(303);
}

void handleOff() {
  digitalWrite(ledPin, LOW);
  server.sendHeader("Location", "/");
  server.send(303);
}